<?xml version="1.0" encoding="ISO-8859-1"?>
<!--  The tags attribute is a free test attribute which meaning is defined by the uHAL user -->
<node id="top">
  <node id="GEM_AMC">

    <!--TTC module -->
    <node id="TTC"  address="0x00300000"
          description="TTC control and monitoring. It takes care of locking to the TTC clock coming from the backplane as well as decoding TTC commands and forwarding that to all other modules in the design. It also provides several control and monitoring registers (resets, command decoding configuration, clock and data status, bc0 status, command counters and a small spy buffer)"
          fw_is_module="true"
          fw_module_file="../common/hdl/ttc/ttc.vhd"
          fw_user_clock_signal="clk_40"
          fw_bus_clock_signal="ipb_clk_i"
          fw_bus_reset_signal="ipb_reset_i"
          fw_master_bus_signal="ipb_mosi_i"
          fw_slave_bus_signal="ipb_miso_o"
          fw_reg_addr_msb="5"
          fw_reg_addr_lsb="0">
        <node id="CTRL" address="0x0" description="TTC control">
            <node id="MODULE_RESET" address="0x0" mask="0x80000000" permission="w" description="TTC module reset"
                  fw_signal="ttc_ctrl.reset_local" fw_is_write_pulse="true" fw_write_pulse_length="1"/>
            <node id="MMCM_RESET" address="0x0" mask="0x40000000" permission="w" description="TTC MMCM reset"
                  fw_signal="ttc_ctrl.mmcm_reset" fw_is_write_pulse="true" fw_write_pulse_length="3"/>
            <node id="CNT_RESET" address="0x0" mask="0x20000000" permission="w" description="TTC counter reset"
                  fw_signal="ttc_ctrl.cnt_reset" fw_is_write_pulse="true" fw_write_pulse_length="1"
                  sw_ctrl_configure_set="0x1" sw_ctrl_start_set="0x1"/>
            <node id="MMCM_PHASE_SHIFT" address="0x0" mask="0x10000000" permission="w" description="TTC MMCM phase shift trigger"
                  fw_signal="ttc_ctrl.mmcm_phase_shift" fw_is_write_pulse="true" fw_write_pulse_length="1"/>
            <node id="L1A_ENABLE" address="0x0" mask="0x00000001" permission="rw" description="Enable L1As (L1As are blocked if this is 0)"
                  fw_signal="ttc_ctrl.l1a_enable" fw_default="0b1"
                  sw_ctrl_configure_set="0x0" sw_ctrl_start_set="0x1" sw_ctrl_stop_set="0x0"/>
        </node>
        <node id="CONFIG" address="0x1" description="TTC configuration -- used for setup TTC command decoding">
            <node id="CMD_BC0" address="0x0" mask="0x000000ff" permission="rw" description="BC0 command code"
                  fw_signal="ttc_conf.cmd_bc0" fw_default="0x01"
                  sw_ctrl_configure_confdb_check_set="true"/>
            <node id="CMD_EC0" address="0x0" mask="0x0000ff00" permission="rw" description="EC0 command code"
                  fw_signal="ttc_conf.cmd_ec0" fw_default="0x02"
                  sw_ctrl_configure_confdb_check_set="true"/>
            <node id="CMD_RESYNC" address="0x0" mask="0x00ff0000" permission="rw" description="Resync command code"
                  fw_signal="ttc_conf.cmd_resync" fw_default="0x04"
                  sw_ctrl_configure_confdb_check_set="true"/>
            <node id="CMD_OC0" address="0x0" mask="0xff000000" permission="rw" description="OC0 command code"
                  fw_signal="ttc_conf.cmd_oc0" fw_default="0x08"
                  sw_ctrl_configure_confdb_check_set="true"/>
            <node id="CMD_HARD_RESET" address="0x1" mask="0x000000ff" permission="rw" description="Hard-reset command code"
                  fw_signal="ttc_conf.cmd_hard_reset" fw_default="0x10"
                  sw_ctrl_configure_confdb_check_set="true"/>
            <node id="CMD_CALPULSE" address="0x1" mask="0x0000ff00" permission="rw" description="Calibration pulse command code"
                  fw_signal="ttc_conf.cmd_calpulse" fw_default="0x14"
                  sw_ctrl_configure_confdb_check_set="true"/>
            <node id="CMD_START" address="0x1" mask="0x00ff0000" permission="rw" description="START command code"
                  fw_signal="ttc_conf.cmd_start" fw_default="0x18"
                  sw_ctrl_configure_confdb_check_set="true"/>
            <node id="CMD_STOP" address="0x1" mask="0xff000000" permission="rw" description="STOP command code"
                  fw_signal="ttc_conf.cmd_stop" fw_default="0x1c"
                  sw_ctrl_configure_confdb_check_set="true"/>
            <node id="CMD_TEST_SYNC" address="0x2" mask="0x000000ff" permission="rw" description="Test-sync command code"
                  fw_signal="ttc_conf.cmd_test_sync" fw_default="0x20"
                  sw_ctrl_configure_confdb_check_set="true"/>
        </node>
        <node id="STATUS" address="0x4" description="TTC status">
            <node id="MMCM_LOCKED" address="0x0" mask="0x00000001" permission="r" description="MMCM locked flag"
                  fw_signal="ttc_status.mmcm_locked"
                  sw_monitor_error_value="0"/>
            <node id="TTC_SINGLE_ERROR_CNT" address="0x1" mask="0x0000ffff" permission="r" description="TTC stream single bit error count"
                  fw_signal="ttc_status.single_err"
                  sw_monitor_warn_min_threshold="1"/>
            <node id="TTC_DOUBLE_ERROR_CNT" address="0x1" mask="0xffff0000" permission="r" description="TTC stream double bit error count"
                  fw_signal="ttc_status.double_err"
                  sw_monitor_error_min_threshold="1"/>
            <node id="BC0" address="0x2" description="TTC status">
                <node id="LOCKED" address="0x0" mask="0x00000001" permission="r" description="BC0 locked flag"
                      fw_signal="ttc_status.bc0_status.locked"
                      sw_monitor_error_value="0"/>
                <node id="UNLOCK_CNT" address="0x1" mask="0x0000ffff" permission="r" description="BC0 unlock count"
                      fw_signal="ttc_status.bc0_status.unlocked_cnt"
                      sw_monitor_error_min_threshold="1"/>
                <node id="OVERFLOW_CNT" address="0x2" mask="0x0000ffff" permission="r" description="BX counter overflow count (late or no BC0 received)"
                      fw_signal="ttc_status.bc0_status.ovf_cnt"
                      sw_monitor_error_min_threshold="1"/>
                <node id="UNDERFLOW_CNT" address="0x2" mask="0xffff0000" permission="r" description="BX counter underflow count (early BC0 received, one is normal after the TTC module reset, but this should be reset by control software before each run)"
                      fw_signal="ttc_status.bc0_status.udf_cnt"
                      sw_monitor_error_min_threshold="1"/>
            </node>
        </node>

        <node id="CMD_COUNTERS" address="0x9" description="TTC command counters">
            <node id="L1A" address="0x0" mask="0xffffffff" permission="r" description="L1A count"
                  fw_signal="ttc_cmds_cnt_arr(0)"/>
            <node id="BC0" address="0x1" mask="0xffffffff" permission="r" description="BC0 count"
                  fw_signal="ttc_cmds_cnt_arr(1)"/>
            <node id="EC0" address="0x2" mask="0xffffffff" permission="r" description="EC0 count"
                  fw_signal="ttc_cmds_cnt_arr(2)"/>
            <node id="RESYNC" address="0x3" mask="0xffffffff" permission="r" description="Resync count"
                  fw_signal="ttc_cmds_cnt_arr(3)"/>
            <node id="OC0" address="0x4" mask="0xffffffff" permission="r" description="OC0 count"
                  fw_signal="ttc_cmds_cnt_arr(4)"/>
            <node id="HARD_RESET" address="0x5" mask="0xffffffff" permission="r" description="Hard-reset count"
                  fw_signal="ttc_cmds_cnt_arr(5)"/>
            <node id="CALPULSE" address="0x6" mask="0xffffffff" permission="r" description="Calibration pulse count"
                  fw_signal="ttc_cmds_cnt_arr(6)"/>
            <node id="START" address="0x7" mask="0xffffffff" permission="r" description="START count"
                  fw_signal="ttc_cmds_cnt_arr(7)"/>
            <node id="STOP" address="0x8" mask="0xffffffff" permission="r" description="STOP count"
                  fw_signal="ttc_cmds_cnt_arr(8)"/>
            <node id="TEST_SYNC" address="0x9" mask="0xffffffff" permission="r" description="Test-sync count"
                  fw_signal="ttc_cmds_cnt_arr(9)"/>
        </node>

        <node id="L1A_ID" address="0x13" mask="0x00ffffff" permission="r" description="L1A ID (increments with every L1A and resets with EC0), used by DAQ to tag event numbers"
              fw_signal="l1id_cnt"/>

        <node id="TTC_SPY_BUFFER" address="0x14" mask="0xffffffff" permission="r" description="TTC Spy buffer -- this is filled with TTC commands (from LSB to MSB) and freezes until the user reads it out, once read out it resets and fills up again with new TTC commands received from that point on"
              fw_signal="ttc_spy_buffer" fw_read_pulse_signal="ttc_spy_reset" fw_read_pulse_length="1"/>
    </node>
    <!--end TTC module -->

    <!--Trigger module -->
    <node id="TTC"  address="0x00800000"
          description="Trigger module handles everything related to sbit cluster data (link synchronization, monitoring, local triggering, matching to L1A and reporting data to DAQ)"
          fw_is_module="true"
          fw_module_file="../common/hdl/trigger/trigger.vhd"
          fw_user_clock_signal="ttc_clk_i.clk_40"
          fw_bus_clock_signal="ipb_clk_i"
          fw_bus_reset_signal="ipb_reset_i"
          fw_master_bus_signal="ipb_mosi_i"
          fw_slave_bus_signal="ipb_miso_o"
          fw_reg_addr_msb="12"
          fw_reg_addr_lsb="0">

        <node id="CTRL" address="0x0" description="Trigger control">
            <node id="MODULE_RESET" address="0x0" mask="0x80000000" permission="w"
                  description="Trigger module reset"
                  fw_signal="reset_local" fw_is_write_pulse="true" fw_write_pulse_length="1"/>
            <node id="CNT_RESET" address="0x0" mask="0x40000000" permission="w"
                  description="Trigger counter reset"
                  fw_signal="reset_cnt" fw_is_write_pulse="true" fw_write_pulse_length="1"
                  sw_ctrl_configure_set="0x1" sw_ctrl_start_set="0x1"/>
            <node id="OH_KILL_MASK" address="0x1" mask="0x00ffffff" permission="rw"
                  description="OH trigger kill mask (kills all sbits from the corresponding OHs)"
                  fw_signal="oh_mask"/>
        </node>

        <node id="STATUS" address="0x10" description="Trigger status">
            <node id="OR_TRIGGER_RATE" address="0x0" mask="0xffffffff" permission="r"
                  description="OR-Trigger rate (Hz) -- this trigger fires whenever there's at least one valid sbit cluster on any link"
                  fw_signal="or_trigger_rate"
                  sw_monitor_warn_min_threshold="1000000"/>
        </node>

        <node id="OH_${OH_IDX}" address="0x100" description="Trigger link for OH ${OH_IDX}"
              generate="true" generate_size="2" generate_address_step="0x100" generate_idx_var="OH_IDX">
            <node id="TRIGGER_RATE" address="0x0" mask="0xffffffff" permission="r"
                  description="Trigger rate (Hz) -- this trigger fires whenever there's at least one valid sbit cluster"
                  fw_signal="trigger_rate(${OH_IDX})"
                  sw_monitor_warn_min_threshold="1000000"/>
            <node id="CLUSTER_SIZE_${CS_IDX}_RATE" address="0x1" mask="0xffffffff" permission="r"
                  description="Rate of cluster size ${CS_IDX} (size 0 means no sbit clusters)"
                  fw_signal="cluster_cnt_rate(${OH_IDX} * 9 + ${CS_IDX})"/>
            <node id="LINK0_NOT_VALID_CNT" address="0xa" mask="0x0000ffff" permission="r"
                  description="Count of valid flag being 0 in the sync FIFO for link 0"
                  fw_signal="not_valid_cnt(${OH_IDX})(15 downto 0)"
                  sw_monitor_error_min_threshold="100"/>
            <node id="LINK1_NOT_VALID_CNT" address="0xa" mask="0xffff0000" permission="r"
                  description="Count of valid flag being 0 in the sync FIFO for link 1"
                  fw_signal="not_valid_cnt(${OH_IDX})(31 downto 16)"
                  sw_monitor_error_min_threshold="100"/>
            <node id="LINK0_MISSED_COMMA_CNT" address="0xb" mask="0x0000ffff" permission="r"
                  description="Count of missed comma character at the expected time for link 0 (this indicates an out-of-sync condition)"
                  fw_signal="missed_comma_cnt(${OH_IDX})(15 downto 0)"
                  sw_monitor_error_min_threshold="1"/>
            <node id="LINK1_MISSED_COMMA_CNT" address="0xb" mask="0xffff0000" permission="r"
                  description="Count of missed comma character at the expected time for link 1 (this indicates an out-of-sync condition)"
                  fw_signal="missed_comma_cnt(${OH_IDX})(31 downto 16)"
                  sw_monitor_error_min_threshold="1"/>
            <node id="LINK0_OVERFLOW_CNT" address="0xc" mask="0x0000ffff" permission="r"
                  description="Count of overflow occurances in the sync FIFO for link 0"
                  fw_signal="link_overflow_cnt(${OH_IDX})(15 downto 0)"
                  sw_monitor_error_min_threshold="1"/>
            <node id="LINK1_OVERFLOW_CNT" address="0xc" mask="0xffff0000" permission="r"
                  description="Count of overflow occurances in the sync FIFO for link 1"
                  fw_signal="link_overflow_cnt(${OH_IDX})(31 downto 16)"
                  sw_monitor_error_min_threshold="1"/>
            <node id="LINK0_UNDERFLOW_CNT" address="0xd" mask="0x0000ffff" permission="r"
                  description="Count of underflow occurances in the sync FIFO for link 0"
                  fw_signal="link_underflow_cnt(${OH_IDX})(15 downto 0)"
                  sw_monitor_error_min_threshold="1"/>
            <node id="LINK1_UNDERFLOW_CNT" address="0xd" mask="0xffff0000" permission="r"
                  description="Count of underflow occurances in the sync FIFO for link 1"
                  fw_signal="link_underflow_cnt(${OH_IDX})(31 downto 16)"
                  sw_monitor_error_min_threshold="1"/>
            <node id="LINK0_SYNC_WORD_CNT" address="0xe" mask="0x0000ffff" permission="r"
                  description="Count of sync words seen on link 0"
                  fw_signal="sync_word_cnt(${OH_IDX})(15 downto 0)"/>
            <node id="LINK1_SYNC_WORD_CNT" address="0xe" mask="0xffff0000" permission="r"
                  description="Count of sync words seen on link 1"
                  fw_signal="sync_word_cnt(${OH_IDX})(31 downto 16)"/>
        </node>

    </node>
    <!--end trigger module -->

  </node>
</node>
